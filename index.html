<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Calculator from Spreadsheet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        input[type="file"] { margin-top: 10px; }
        #results-container { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .location-item { margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px; }
    </style>
    <!-- Include the SheetJS library from a CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Distance to Locations from Spreadsheet</h1>
    <p>
        **Instructions:** First, allow the browser to access your location. Then, select a spreadsheet file (.xlsx or .csv) containing "lat" and "long" columns.
    </p>
    
    <input type="file" id="fileInput" accept=".xlsx,.csv">
    
    <div id="results-container">
        <!-- Results will be displayed here -->
    </div>
</div>

<script>

// --- Main logic to read file and calculate distances ---
const destinations = [
  'Statue of Liberty, New York, NY',
  '233 S Wacker Dr, Chicago, IL',
  'Golden Gate Bridge, San Francisco, CA'
];

async function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) {
        document.getElementById('results-container').innerHTML = "<p>No file selected.</p>";
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        // Get user's current location using Geolocation API
        if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
			  (position) => {
				const userLatLng = new google.maps.LatLng(
				  position.coords.latitude,
				  position.coords.longitude
				);
				calculateDistances(userLatLng);
			},
            () => {
                document.getElementById('results-container').innerHTML = "<p>Could not get your location. Please allow location access.</p>";
            });
        } else {
            document.getElementById('results-container').innerHTML = "<p>Geolocation is not supported by your browser.</p>";
        }
    };
    reader.readAsArrayBuffer(file);
}

function calculateDistances(origin) {
  const service = new google.maps.DistanceMatrixService();
  
  const matrixOptions = {
    origins: [origin],
    destinations: destinations,
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.IMPERIAL, // or google.maps.UnitSystem.METRIC
  };

  service.getDistanceMatrix(matrixOptions, callback);
}

function callback(response, status) {
  const resultsDiv = document.getElementById('distance-results');
  if (status === "OK") {
    const results = response.rows[0].elements;
    resultsDiv.innerHTML = "<h2>Results:</h2>";
    for (let i = 0; i < results.length; i++) {
      const element = results[i];
      const destinationAddress = destinations[i];
      const distanceText = element.distance.text;
      const durationText = element.duration.text;
      
      resultsDiv.innerHTML += `
        <p>
          <strong>To:</strong> ${destinationAddress}<br>
          <strong>Distance:</strong> ${distanceText}<br>
          <strong>Duration:</strong> ${durationText}
        </p>
      `;
    }
  } else {
    resultsDiv.innerHTML = `Error with Distance Matrix service: ${status}`;
  }
}

function handleLocationError(browserHasGeolocation) {
  const resultsDiv = document.getElementById('distance-results');
  resultsDiv.innerHTML = browserHasGeolocation
    ? "Error: The Geolocation service failed."
    : "Error: Your browser doesn't support geolocation.";
}

// Attach event listener to the file input
document.getElementById('fileInput').addEventListener('change', processFile);
</script>

</body>
</html>
